<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda: Creche e Hotel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <!-- Nova fonte arredondada para o título -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Novo estilo para a fonte do título */
        h1.gradient-text {
            font-family: 'Nunito', sans-serif;
        }
        /* For custom scrollbars if needed */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Custom gradient text for title - Updated Color */
        .gradient-text {
            background: linear-gradient(to right, #2dd4bf, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Hide number input spinners */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] { -moz-appearance: textfield; }
        /* Calendar Styles */
        .calendar-day { transition: all 0.2s ease; }
        .calendar-day.selected { background-color: #0d9488; color: white; border-radius: 50%; font-weight: bold; }
        .calendar-day.today { border: 2px solid #0d9488; border-radius: 50%; }
        /* Style for select options */
        .form-select-dark-text option { color: black; background-color: white; }
        /* Card status colors */
        .status-presente { background-color: #dcfce7 !important; border: 1px solid #22c55e; }
        .status-ausente { background-color: #fee2e2 !important; border: 1px solid #ef4444; }
        .status-hospedado { background-color: #cffafe !important; border: 1px solid #06b6d4; }
        .status-finalizado { background-color: #f3e8ff !important; border: 1px solid #9333ea; }
        /* Smooth transitions */
        aside, #content-area {
            transition: all 0.3s ease-in-out;
        }
        #booking-sidebar.hidden-sidebar {
            width: 0 !important;
            min-width: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            opacity: 0;
            transform: translateX(-100%);
            border: none !important;
            overflow: hidden;
        }
        .action-btn {
            font-family: 'Poppins', sans-serif;
            color: white;
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }

        #booking-sidebar .form-input,
        #booking-sidebar .form-select-dark-text {
            color: #374151;
            background-color: #ffffff;
            border-color: #d1d5db;
        }

        #booking-sidebar .form-input::placeholder {
            color: #9ca3af;
        }
         #booking-sidebar label {
            color: white;
        }
        
        #area-geral {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        #area-geral h2, .coluna-grupo h2 {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1rem;
            color: #4b5563;
        }
        
        /* Default grid layout for all card containers */
        #list-container,
        .card-grid {
             display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }
        
        .container-grupos {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .coluna-grupo {
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            border: 2px solid #e5e7eb;
            min-height: 200px;
        }
        
        .botoes-porte {
            position: absolute;
            bottom: 4rem; 
            right: 0.5rem;
            display: flex;
            gap: 0.25rem;
        }
        .btn-mover-porte {
             background-color: rgba(0,0,0,0.2);
             color: white;
             border-radius: 50%;
             width: 24px;
             height: 24px;
             font-size: 0.75rem;
             font-weight: bold;
             display: flex;
             align-items: center;
             justify-content: center;
             transition: background-color 0.2s;
        }
        .btn-mover-porte:hover {
            background-color: rgba(0,0,0,0.4);
        }
         .area-contadores {
            padding: 0.75rem;
            background-color: #eef2ff;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.875rem;
            color: #4338ca;
            flex-wrap: wrap;
        }
        
        .appointment-card .tutor-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; 
            max-width: 150px;
        }

        /* --- Estilos do Modo Compacto --- */
        .appointment-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, max-height 0.4s ease-in-out;
        }

        /* Mobile-first: default to 2 columns for compact mode */
        .modo-compacto .card-grid, 
        .modo-compacto #list-container, 
        .modo-compacto #historico-list-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        /* For tablets and up, use auto-fill for more columns */
        @media (min-width: 768px) {
            .modo-compacto .card-grid, 
            .modo-compacto #list-container, 
            .modo-compacto #historico-list-container {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        .modo-compacto .appointment-card {
            cursor: pointer;
            padding: 0.75rem;
        }
        
        .modo-compacto .appointment-card .card-details {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-top: 0;
            transition: max-height 0.4s ease-out, opacity 0.2s ease-out;
        }

        .modo-compacto .appointment-card.expandido {
            position: relative;
            z-index: 10;
            transform: scale(1.08);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }

        .modo-compacto .appointment-card.expandido .card-details {
            max-height: 500px; /* Valor alto para garantir que todo o conteúdo caiba */
            opacity: 1;
            margin-top: 0.5rem;
        }
        /* --- Fim dos Estilos do Modo Compacto --- */

        /* --- Estilos do Histórico de Serviço --- */
        #historico-servicos {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e5e7eb;
        }
        #historico-servicos h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 1rem;
        }
        .controles-filtro {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .filtro-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .filtro-item label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #4b5563;
        }
        .filtro-item input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            min-width: 220px;
        }
        #historico-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            min-height: 100px;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div class="container mx-auto p-4 md:p-8 min-h-screen flex items-center justify-center">
        <div class="w-full max-w-7xl bg-white rounded-2xl shadow-2xl p-6 md:p-8 space-y-6">
            
            <header class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold gradient-text">Agenda: Creche e Hotel</h1>
                <p id="user-id-display" class="text-xs text-gray-400 mt-2">Carregando...</p>
            </header>

            <nav class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button data-tab="reception" class="tab-btn active-tab flex items-center justify-center gap-2">
                    <i data-feather="clipboard" class="w-4 h-4"></i><span>Recepção</span>
                </button>
                <button data-tab="creche" class="tab-btn flex items-center justify-center gap-2">
                    <i data-feather="sun" class="w-4 h-4"></i><span>Creche</span>
                </button>
                <button data-tab="hotel" class="tab-btn flex items-center justify-center gap-2">
                    <i data-feather="moon" class="w-4 h-4"></i><span>Hotel</span>
                </button>
                <button data-tab="taxi" class="tab-btn flex items-center justify-center gap-2">
                    <i data-feather="truck" class="w-4 h-4"></i><span>Taxi Dog</span>
                </button>
            </nav>

            <!-- Main content area now stacks vertically on mobile -->
            <main id="main-content" class="flex flex-col md:flex-row gap-6 md:gap-8 relative">
                
                <!-- Sidebar with responsive width and flex-shrink behavior - Updated Colors -->
                <aside id="booking-sidebar" class="w-full md:w-1/3 lg:w-1/4 p-6 bg-gradient-to-br from-teal-400 to-cyan-500 text-white rounded-xl shadow-lg border-2 border-purple-300 min-w-[320px] flex-shrink-0">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold whitespace-nowrap flex items-center gap-2">
                            <i data-feather="plus-circle" class="w-6 h-6"></i>
                            <span>Novo Agendamento</span>
                        </h2>
                    </div>
                    <form id="booking-form" class="space-y-4 overflow-y-auto">
                        </form>
                </aside>

                <!-- Content area now grows to fill available space -->
                <div id="content-area" class="w-full flex-grow bg-white p-6 rounded-xl border-2 border-purple-300 shadow-inner">
                    <div id="content-display" class="space-y-6">
                        </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
             <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Editar Agendamento</h3>
                    <button id="close-edit-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                </div>
                <form id="edit-form" class="space-y-4">
                    </form>
            </div>
        </div>
    </div>

    <div id="checklist-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
             <div id="printable-checklist" class="p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h3 class="text-2xl font-bold text-gray-800">Checklist de Hospedagem</h3>
                    <button id="close-checklist-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl leading-none no-print">&times;</button>
                </div>
                <form id="checklist-form" class="space-y-4">
                    <div id="checklist-info" class="mb-6"></div>
                    <div id="checklist-items" class="space-y-4"></div>
                     <div class="mt-6 border-t pt-4">
                         <label for="observacoes-gerais" class="block text-sm font-semibold text-gray-700 mb-2">Observações Gerais</label>
                         <textarea id="observacoes-gerais" name="observacoes-gerais" rows="3" class="form-input w-full p-2 border rounded-md"></textarea>
                    </div>
                     <div class="mt-8 border-t pt-8 flex items-end gap-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-1 whitespace-nowrap">Assinatura do Tutor:</label>
                        <div class="border-b border-gray-400 w-full"></div>
                    </div>
                    <div class="flex justify-end pt-4 gap-4 no-print">
                        <button type="button" id="print-checklist-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Imprimir</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Salvar Checklist</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Confirmar Ação</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Você tem certeza?</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4">Acesso Restrito</h3>
            <p class="text-gray-600 mb-4">Por favor, insira a senha para acessar esta área.</p>
            <input type="password" id="password-input" class="form-input w-full mb-4 text-center border-gray-300 focus:ring-teal-500 focus:border-teal-500">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">Senha incorreta.</p>
            <button id="password-submit-btn" class="w-full px-6 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600">Entrar</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, Timestamp, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCFbwPsOyYD3HtSegk0j0zDGGOcjnc1Zn4",
            authDomain: "creche-14172.firebaseapp.com",
            projectId: "creche-14172",
            storageBucket: "creche-14172.appspot.com",
            messagingSenderId: "495724593146",
            appId: "1:495724593146:web:74c18a306d8de607a66e43",
            measurementId: "G-0MVHX1PXE4"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let appointmentsColRef = null;
        let unsubscribeAppointments = null;
        
        let localAppointments = [];
        let currentTab = 'reception';
        const todayStr = new Date().toISOString().split('T')[0];
        const dateFilters = {
            reception: todayStr,
            creche: todayStr,
            hotel: todayStr,
            taxi: todayStr,
        };
        let receptionSearchTerm = '';
        let currentHotelFilter = 'Hospedado';
        let currentCrecheStatusFilter = '';
        let currentTaxiRouteFilter = '';
        let currentServiceFilter = '';
        let isSidebarVisible = true;
        let cardGroupAssignments = {};
        let selectedPackageDates = [];
        let calendarDate = new Date();
        let isCompactMode = false;
        let isUnlocked = false;
        let pendingTab = null;

        // --- DOM ELEMENTS (CACHE) ---
        const mainContent = document.getElementById('main-content');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const contentDisplay = document.getElementById('content-display');
        const contentArea = document.getElementById('content-area');
        const bookingSidebar = document.getElementById('booking-sidebar');
        const bookingForm = document.getElementById('booking-form');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const checklistModal = document.getElementById('checklist-modal');
        const checklistForm = document.getElementById('checklist-form');
        const checklistInfo = document.getElementById('checklist-info');
        const checklistItemsContainer = document.getElementById('checklist-items');
        const closeChecklistModalBtn = document.getElementById('close-checklist-modal-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const passwordError = document.getElementById('password-error');

        // --- FORM TEMPLATE ---
        const getFormHTML = (idPrefix = "") => `
            <input type="hidden" id="${idPrefix}booking-id">
            <div>
                <label for="${idPrefix}tutor-name" class="block text-sm font-medium">Nome do Tutor</label>
                <input type="text" id="${idPrefix}tutor-name" class="form-input" required>
            </div>
            <div>
                <label for="${idPrefix}pet-name" class="block text-sm font-medium">Nome do Pet</label>
                <input type="text" id="${idPrefix}pet-name" class="form-input" required>
            </div>
            <div>
                <label for="${idPrefix}pet-breed" class="block text-sm font-medium">Raça do Pet</label>
                <input type="text" id="${idPrefix}pet-breed" class="form-input" required>
            </div>
            
            <div id="${idPrefix}generic-date-container" class="space-y-2">
                <label for="${idPrefix}generic-date" class="block text-sm font-medium">Data do Agendamento</label>
                <input type="datetime-local" id="${idPrefix}generic-date" class="form-input">
            </div>
            
            <fieldset class="pt-2">
                <legend class="text-sm font-medium mb-2">Serviços Solicitados</legend>
                <div class="space-y-2">
                    <div class="flex items-center"><input type="checkbox" id="${idPrefix}service-package-creche" class="form-checkbox"> <label for="${idPrefix}service-package-creche" class="ml-2">Pacote de Creche</label></div>
                    <div class="flex items-center"><input type="checkbox" id="${idPrefix}service-creche" class="form-checkbox"> <label for="${idPrefix}service-creche" class="ml-2">Creche</label></div>
                    <div class="flex items-center"><input type="checkbox" id="${idPrefix}service-hotel" class="form-checkbox"> <label for="${idPrefix}service-hotel" class="ml-2">Hotel</label></div>
                    <div class="flex items-center"><input type="checkbox" id="${idPrefix}service-taxi" class="form-checkbox"> <label for="${idPrefix}service-taxi" class="ml-2">Taxi Dog</label></div>
                </div>
            </fieldset>

            <div id="${idPrefix}hotel-details-container" class="hidden space-y-4 pt-2 border-t border-teal-500">
                <h3 class="font-semibold text-center">Detalhes da Hospedagem</h3>
                <div>
                    <label for="${idPrefix}hotel-checkin-date" class="block text-sm font-medium">Check-in do Hotel</label>
                    <input type="datetime-local" id="${idPrefix}hotel-checkin-date" class="form-input">
                </div>
                <div>
                    <label for="${idPrefix}hotel-checkout-date" class="block text-sm font-medium">Check-out do Hotel</label>
                    <input type="datetime-local" id="${idPrefix}hotel-checkout-date" class="form-input">
                </div>
                <div class="flex items-center pl-2"><input type="checkbox" id="${idPrefix}service-bath" class="form-checkbox"> <label for="${idPrefix}service-bath" class="ml-2">Saída com Banho</label></div>
            </div>

            <div id="${idPrefix}package-calendar-container" class="hidden space-y-2 pt-2 border-t border-teal-500">
                 <h3 class="font-semibold text-center">Selecione os Dias do Pacote</h3>
                 <div id="${idPrefix}calendar" class="bg-white/10 p-3 rounded-lg"></div>
            </div>
            
            <div id="${idPrefix}taxi-dog-details-container" class="hidden space-y-4 pt-2 border-t border-teal-500">
                <h3 class="font-semibold text-center">Detalhes do Taxi Dog</h3>
                 <div>
                    <label for="${idPrefix}taxi-pickup-time" class="block text-sm font-medium">Horário de Busca</label>
                    <input type="time" id="${idPrefix}taxi-pickup-time" class="form-input">
                </div>
                <div>
                    <label for="${idPrefix}taxi-return-time" class="block text-sm font-medium">Horário de Devolução</label>
                    <input type="time" id="${idPrefix}taxi-return-time" class="form-input">
                </div>
                <div>
                    <label for="${idPrefix}taxi-route" class="block text-sm font-medium">Rota</label>
                    <select id="${idPrefix}taxi-route" class="form-input form-select-dark-text" required>
                        <option value="">Selecione a rota</option>
                        <option value="Rafael">Rafael</option>
                        <option value="Douglas">Douglas</option>
                        <option value="Matheus">Matheus</option>
                        <option value="Avulso">Avulso</option>
                    </select>
                </div>
            </div>

            <div>
                <label for="${idPrefix}observations" class="block text-sm font-medium">Observações</label>
                <textarea id="${idPrefix}observations" rows="3" class="form-input"></textarea>
            </div>

            <div class="flex flex-col space-y-2 pt-4">
                 <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 shadow-md">Salvar</button>
            </div>
        `;
        
        // --- AUTHENTICATION & INITIALIZATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const dataAppId = "petshop-agenda-dev";
                const dataUserID = "vHtPJnEWkYh1hIhINpU5bJydLev1";
                
                userIdDisplay.textContent = `Visualizando dados de: ${dataUserID.substring(0, 10)}...`;
                
                const collectionPath = `artifacts/${dataAppId}/users/${dataUserID}/appointments`;
                appointmentsColRef = collection(db, collectionPath);
                
                listenForAppointments();
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) { 
                    console.error("Authentication failed:", error); 
                    userIdDisplay.textContent = "Erro de autenticação."; 
                }
            }
        });

        function listenForAppointments() {
            if (unsubscribeAppointments) unsubscribeAppointments();
            if (!appointmentsColRef) return;
            unsubscribeAppointments = onSnapshot(appointmentsColRef, (snapshot) => {
                localAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContent();
            }, (error) => { console.error("Error fetching appointments:", error); contentDisplay.innerHTML = `<p class="text-red-500">Erro ao carregar agendamentos. Verifique o caminho da coleção e as regras de segurança do Firestore.</p>`; });
        }
        
        const addStyles = () => {
            const style = document.createElement('style');
            style.textContent = `
                .tab-btn { padding: 0.75rem 1rem; font-weight: 600; color: #14b8a6; background-color: #f0fdfa; border: 2px solid #a78bfa; border-radius: 0.5rem; transition: all 0.3s ease; }
                .tab-btn:hover { background-color: #ccfbf1; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
                .tab-btn.active-tab { color: white; background-image: linear-gradient(to right, #2dd4bf, #06b6d4); border-color: #6d28d9; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
                .form-input, .form-select-dark-text { width: 100%; background-color: rgba(0, 0, 0, 0.1); border: 1px solid rgba(0, 0, 0, 0.3); border-radius: 0.5rem; padding: 0.75rem; color: #374151; transition: background-color 0.3s, border-color 0.3s; }
                #booking-sidebar .form-input, #booking-sidebar .form-select-dark-text { color: #374151; background-color: #ffffff; border-color: #d1d5db; }
                #booking-sidebar .form-input::placeholder { color: #9ca3af; }
                #booking-sidebar label { color: white; }
                .form-checkbox { width: 1.25rem; height: 1.25rem; border-radius: 0.25rem; border-color: rgba(255, 255, 255, 0.3); background-color: transparent; accent-color: #8b5cf6; }
                #edit-form .form-checkbox { border-color: #9ca3af; }
                .action-btn { font-family: 'Poppins', sans-serif; font-size: 0.7rem; color: white; padding: 0.375rem 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s; }
            `;
            document.head.appendChild(style);
        };
        addStyles();

        // --- FORM LOGIC INITIALIZER ---
        function initializeFormLogic(prefix = "") {
            const form = document.getElementById(prefix ? 'edit-form' : 'booking-form'); if (!form) return;
            const hotelCheckbox = document.getElementById(`${prefix}service-hotel`), crecheCheckbox = document.getElementById(`${prefix}service-creche`), packageCrecheCheckbox = document.getElementById(`${prefix}service-package-creche`), taxiCheckbox = document.getElementById(`${prefix}service-taxi`);
            const genericDateContainer = document.getElementById(`${prefix}generic-date-container`), hotelDetailsContainer = document.getElementById(`${prefix}hotel-details-container`), taxiDetailsContainer = document.getElementById(`${prefix}taxi-dog-details-container`), packageCalendarContainer = document.getElementById(`${prefix}package-calendar-container`);
            const updateVisibility = () => {
                const isHotel = hotelCheckbox.checked;
                hotelDetailsContainer.classList.toggle('hidden', !isHotel);
                taxiDetailsContainer.classList.toggle('hidden', !taxiCheckbox.checked);
                genericDateContainer.classList.toggle('hidden', isHotel);
                const taxiRoute = document.getElementById(`${prefix}taxi-route`);
                if (taxiRoute) taxiRoute.required = taxiCheckbox.checked;
            };
            packageCrecheCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                packageCalendarContainer.classList.toggle('hidden', !isChecked);
                if (isChecked) { crecheCheckbox.checked = true; crecheCheckbox.disabled = true; renderCalendar(prefix); } 
                else { crecheCheckbox.disabled = false; selectedPackageDates = []; }
                updateVisibility();
            });
            crecheCheckbox.addEventListener('change', (e) => {
                if (!e.target.checked && !packageCrecheCheckbox.disabled) { packageCrecheCheckbox.checked = false; packageCalendarContainer.classList.add('hidden'); selectedPackageDates = []; }
                updateVisibility();
            });
            hotelCheckbox.addEventListener('change', updateVisibility);
            taxiCheckbox.addEventListener('change', updateVisibility);
            updateVisibility();
        }

        // --- UI & TAB LOGIC (Refactored for Mobile) ---
        function switchTab(tabId) {
            currentTab = tabId;
            tabButtons.forEach(btn => {
                btn.classList.toggle('active-tab', btn.dataset.tab === tabId);
            });
            updateLayoutForTab();
            renderContent();
        }

        function updateLayoutForTab() {
            const isReception = currentTab === 'reception';
            if (isReception) {
                bookingSidebar.classList.toggle('hidden-sidebar', !isSidebarVisible);
            } else {
                bookingSidebar.classList.add('hidden-sidebar');
            }
            feather.replace();
        }

        function toggleSidebar(visible) {
            isSidebarVisible = visible;
            bookingSidebar.classList.toggle('hidden-sidebar', !isSidebarVisible);
            const sidebarToggle = document.getElementById('sidebar-toggle-btn');
            if (sidebarToggle) {
                sidebarToggle.innerHTML = `<i data-feather="${isSidebarVisible ? 'chevron-left' : 'chevron-right'}"></i>`;
                feather.replace();
            }
        }
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                if (tabId !== 'reception' && !isUnlocked) {
                    pendingTab = tabId;
                    passwordModal.classList.remove('hidden');
                    passwordInput.focus();
                    return;
                }
                switchTab(tabId);
            });
        });

        passwordSubmitBtn.addEventListener('click', () => {
            if (passwordInput.value === '256') {
                isUnlocked = true;
                passwordModal.classList.add('hidden');
                passwordInput.value = '';
                passwordError.classList.add('hidden');
                if (pendingTab) {
                    switchTab(pendingTab);
                    pendingTab = null;
                }
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
            }
        });
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                passwordSubmitBtn.click();
            }
        });


        // --- CALENDAR LOGIC ---
        function renderCalendar(prefix = "") {
            const calendarEl = document.getElementById(`${prefix}calendar`); if (!calendarEl) return;
            calendarEl.innerHTML = '';
            const month = calendarDate.getMonth(), year = calendarDate.getFullYear();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const textColor = prefix ? 'text-gray-800' : 'text-white';
            let header = document.createElement('div');
            header.className = `flex items-center justify-between mb-2 ${textColor}`;
            header.innerHTML = `<button type="button" id="${prefix}prev-month" class="p-1 rounded-full hover:bg-black/10">&lt;</button><span class="font-bold">${monthNames[month]} ${year}</span><button type="button" id="${prefix}next-month" class="p-1 rounded-full hover:bg-black/10">&gt;</button>`;
            calendarEl.appendChild(header);
            let grid = document.createElement('div');
            grid.className = `grid grid-cols-7 gap-1 text-center text-sm ${textColor}`;
            grid.innerHTML = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].map(day => `<div class="font-bold text-teal-500">${day}</div>`).join('');
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('button');
                dayEl.type = 'button';
                dayEl.textContent = i;
                const dateString = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                dayEl.className = 'p-1 calendar-day';
                if (selectedPackageDates.includes(dateString)) dayEl.classList.add('selected');
                dayEl.addEventListener('click', () => {
                    const index = selectedPackageDates.indexOf(dateString);
                    if (index > -1) selectedPackageDates.splice(index, 1);
                    else selectedPackageDates.push(dateString);
                    renderCalendar(prefix);
                });
                grid.appendChild(dayEl);
            }
            calendarEl.appendChild(grid);
            document.getElementById(`${prefix}prev-month`).addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(prefix); });
            document.getElementById(`${prefix}next-month`).addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(prefix); });
        }
        
        // --- MAIN RENDER FUNCTION ---
        function renderContent() {
            if (!appointmentsColRef) return;
            contentDisplay.innerHTML = '';
            
            contentDisplay.classList.toggle('modo-compacto', isCompactMode);
            
            let filteredAppointments = [];
            let headerHTML = '';
             switch (currentTab) {
                case 'reception': headerHTML = createFilterHeader('reception'); filteredAppointments = filterReception(); break;
                case 'creche': {
                    const d = new Date(dateFilters.creche + 'T00:00:00');
                    const s = toStartOfDay(d), e = toEndOfDay(d);
                    const dailyCrecheAppointments = localAppointments.filter(a => (a.services.includes('Creche') || a.services.includes('Pacote de Creche')) && a.checkinDate?.toDate() >= s && a.checkinDate?.toDate() <= e );
                    const presentesCount = dailyCrecheAppointments.filter(a => a.status === 'Presente').length;
                    const ausentesCount = dailyCrecheAppointments.filter(a => a.status === 'Ausente').length;
                    const saidaCount = dailyCrecheAppointments.filter(a => a.status === 'Check-out/Finalizado').length;
                    headerHTML = createFilterHeader('creche', { presentes: presentesCount, ausentes: ausentesCount, saida: saidaCount });
                    filteredAppointments = filterCreche();
                    break;
                }
                case 'hotel': {
                    filteredAppointments = filterHotel();
                    const hospedadosCount = filteredAppointments.filter(a => a.status === 'Hospedado').length;
                    headerHTML = createFilterHeader('hotel', { hospedados: hospedadosCount });
                    break;
                }
                case 'taxi': headerHTML = createFilterHeader('taxi'); filteredAppointments = filterTaxi(); break;
            }
            contentDisplay.innerHTML += headerHTML;

            if (currentTab === 'creche' || currentTab === 'hotel') {
                const triageContainer = document.createElement('div');
                triageContainer.id = "triage-container";
                triageContainer.innerHTML = `
                    <div class="area-contadores flex gap-x-6 gap-y-2 mt-4 mb-4 flex-wrap">
                      <div class="flex items-center gap-2"><i data-feather="users" class="w-5 h-5"></i><strong>Geral: <span id="contador-geral">0</span></strong></div>
                      <div class="flex items-center gap-2"><span>Porte Grande: <span id="contador-grandes">0</span></span></div>
                      <div class="flex items-center gap-2"><span>Porte Pequeno: <span id="contador-pequenos">0</span></span></div>
                    </div>
                    <div id="area-geral" class="mb-6">
                        <h2 class="w-full">Aguardando Classificação</h2>
                        <div class="card-grid"></div>
                    </div>
                    <div class="container-grupos">
                      <div id="grupo-grandes" class="coluna-grupo"><h2>Porte Grande</h2><div class="card-grid"></div></div>
                      <div id="grupo-pequenos" class="coluna-grupo"><h2>Porte Pequeno</h2><div class="card-grid"></div></div>
                    </div>`;
                contentDisplay.appendChild(triageContainer);
                const areaGeralGrid = triageContainer.querySelector('#area-geral .card-grid');
                const grupoGrandesGrid = triageContainer.querySelector('#grupo-grandes .card-grid');
                const grupoPequenosGrid = triageContainer.querySelector('#grupo-pequenos .card-grid');

                if(filteredAppointments.length > 0) {
                     filteredAppointments.forEach(appt => {
                        const cardElement = createAppointmentCard(appt);
                        const assignedGroup = cardGroupAssignments[appt.id];
                        if (assignedGroup === 'grandes') {
                            grupoGrandesGrid.appendChild(cardElement);
                        } else if (assignedGroup === 'pequenos') {
                            grupoPequenosGrid.appendChild(cardElement);
                        } else {
                            areaGeralGrid.appendChild(cardElement);
                        }
                    });
                } else {
                     triageContainer.querySelector('#area-geral').innerHTML = `<h2 class="w-full">Aguardando Classificação</h2> <p class="col-span-full text-center text-gray-500 mt-8">Nenhum agendamento encontrado.</p>`;
                }
                atualizarContadores();
            } else {
                const listContainer = document.createElement('div');
                listContainer.id = 'list-container';
                 if (filteredAppointments.length > 0) {
                    filteredAppointments.forEach(appt => {
                        listContainer.appendChild(createAppointmentCard(appt));
                    });
                } else {
                     listContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 mt-8">Nenhum agendamento encontrado.</p>`;
                }
                const mainContentContainer = document.getElementById('reception-main-content') || contentDisplay;
                if(mainContentContainer) mainContentContainer.appendChild(listContainer);
            }
            
            if(currentTab === 'reception'){
                const historySection = document.createElement('section');
                historySection.id = 'historico-servicos';
                historySection.className = 'mt-8 pt-4 border-t-2 border-gray-200';
                historySection.innerHTML = `
                    <h2 class="flex items-center gap-2 text-2xl font-bold text-gray-800 mb-4"><i data-feather="archive" class="w-6 h-6"></i>Histórico de Serviço</h2>
                    <div class="controles-filtro">
                        <div class="filtro-item">
                            <label for="filtro-data-historico">Filtrar por Data:</label>
                            <input type="date" id="filtro-data-historico">
                        </div>
                        <div class="filtro-item">
                            <label for="busca-nome-historico">Buscar por Nome:</label>
                            <input type="search" id="busca-nome-historico" placeholder="Digite o nome do Pet ou Tutor...">
                        </div>
                    </div>
                    <div id="historico-list-container">
                        <p class="text-gray-500 col-span-full">Use os filtros acima para buscar no histórico.</p>
                    </div>
                `;
                contentDisplay.appendChild(historySection);
            }

            addFilterEventListeners();
            feather.replace();
        }

        // --- FILTERING LOGIC ---
        const toStartOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const toEndOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59, 999);
        function filterReception() {
             const d = new Date(dateFilters.reception + 'T00:00:00'), s = toStartOfDay(d), e = toEndOfDay(d); 
             let filtered = localAppointments.filter(a => a.checkinDate?.toDate() >= s && a.checkinDate?.toDate() <= e);
             
             if (currentServiceFilter) {
                 filtered = filtered.filter(a => a.services.includes(currentServiceFilter));
             }
             if (receptionSearchTerm) {
                filtered = filtered.filter(a => 
                    (a.petName?.toLowerCase() || '').includes(receptionSearchTerm) ||
                    (a.tutorName?.toLowerCase() || '').includes(receptionSearchTerm)
                );
            }
             return filtered;
        }
        function filterCreche() { 
            const d = new Date(dateFilters.creche + 'T00:00:00'), s = toStartOfDay(d), e = toEndOfDay(d); 
            let filtered = localAppointments.filter(a => (a.services.includes('Creche') || a.services.includes('Pacote de Creche')) && a.checkinDate?.toDate() >= s && a.checkinDate?.toDate() <= e);
            if (currentCrecheStatusFilter) {
                filtered = filtered.filter(a => a.status === currentCrecheStatusFilter);
            }
            return filtered;
        }
        function filterHotel() {
            const d = new Date(dateFilters.hotel + 'T00:00:00');
            const s = toStartOfDay(d);
            const e = toEndOfDay(d);
            let filtered = localAppointments.filter(a => a.services.includes('Hotel') && a.checkinDate?.toDate() >= s && a.checkinDate?.toDate() <= e );
            if (currentHotelFilter) {
                filtered = filtered.filter(a => a.status === currentHotelFilter);
            }
            return filtered;
        }
        function filterTaxi() { const d = new Date(dateFilters.taxi + 'T00:00:00'), s = toStartOfDay(d), e = toEndOfDay(d); let f = localAppointments.filter(a => a.services.includes('Taxi Dog') && a.checkinDate?.toDate() >= s && a.checkinDate?.toDate() <= e); if (currentTaxiRouteFilter) f = f.filter(a => a.taxiDetails?.route === currentTaxiRouteFilter); return f; }

        // --- UI & HELPERS ---
        function createFilterHeader(type, counts = {}) {
             const sidebarToggleHTML = currentTab === 'reception' ? `<button id="sidebar-toggle-btn" title="Ocultar/Mostrar Barra Lateral" class="p-2 rounded-md bg-purple-100 text-purple-700 hover:bg-purple-200"><i data-feather="${isSidebarVisible ? 'chevron-left' : 'chevron-right'}"></i></button>` : '';
             const compactModeButtonHTML = `<button id="btn-toggle-compacto" class="action-btn bg-gray-500 hover:bg-gray-600">${isCompactMode ? 'Visão Padrão' : 'Modo Compacto'}</button>`;
             let filterHTML = '';
             let countersHTML = ''; 
             
             switch (type) {
                case 'reception':
                    return `<div class="border-b-2 pb-2">
                                <div class="flex justify-between items-center flex-wrap gap-2">
                                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i data-feather="calendar" class="w-6 h-6"></i>Agendamentos do Dia</h2>
                                    <div class="flex items-center gap-2">
                                        ${compactModeButtonHTML}
                                        ${sidebarToggleHTML}
                                    </div>
                                </div>
                                <div class="my-4 flex flex-wrap justify-between items-center gap-4">
                                    <div class="flex flex-wrap items-center gap-4">
                                        <div class="flex items-center gap-2">
                                            <label for="date-filter" class="font-semibold">Data:</label>
                                            <input type="date" id="date-filter" value="${dateFilters.reception}" class="p-2 border rounded-md">
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label for="service-filter" class="font-semibold">Serviço:</label>
                                            <select id="service-filter" class="p-2 border rounded-md form-select-dark-text">
                                                <option value="" ${currentServiceFilter === '' ? 'selected' : ''}>Todos</option>
                                                <option value="Creche" ${currentServiceFilter === 'Creche' ? 'selected' : ''}>Creche</option>
                                                <option value="Hotel" ${currentServiceFilter === 'Hotel' ? 'selected' : ''}>Hotel</option>
                                                <option value="Taxi Dog" ${currentServiceFilter === 'Taxi Dog' ? 'selected' : ''}>Taxi Dog</option>
                                            </select>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <label for="reception-search-filter" class="font-semibold">Buscar:</label>
                                            <input type="search" id="reception-search-filter" value="${receptionSearchTerm}" placeholder="Nome do Pet ou Tutor..." class="p-2 border rounded-md">
                                        </div>
                                    </div>
                                </div>
                                <div id="reception-main-content"></div>
                            </div>`;
                case 'creche': 
                    filterHTML = `<div><h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2 mb-4"><i data-feather="sun" class="w-6 h-6"></i>Visão da Creche</h2><div class="flex flex-wrap items-center gap-4">
                                    <div class="flex items-center gap-2"><label for="date-filter" class="font-semibold">Data:</label><input type="date" id="date-filter" value="${dateFilters[currentTab]}" class="p-2 border rounded-md"></div>
                                    <div class="flex items-center gap-2"><label for="creche-status-filter" class="font-semibold">Status:</label><select id="creche-status-filter" class="p-2 border rounded-md form-select-dark-text"><option value="" ${currentCrecheStatusFilter === '' ? 'selected' : ''}>Todos</option><option value="Agendado" ${currentCrecheStatusFilter === 'Agendado' ? 'selected' : ''}>Agendado</option><option value="Presente" ${currentCrecheStatusFilter === 'Presente' ? 'selected' : ''}>Presente</option><option value="Ausente" ${currentCrecheStatusFilter === 'Ausente' ? 'selected' : ''}>Ausente</option><option value="Check-out/Finalizado" ${currentCrecheStatusFilter === 'Check-out/Finalizado' ? 'selected' : ''}>Saída</option></select></div>
                                    ${compactModeButtonHTML}
                                </div></div>`;
                    if (counts.presentes !== undefined) countersHTML = `<div class="flex gap-x-6 gap-y-2 mt-4 flex-wrap"><div class="flex items-center gap-2 text-green-600"><i data-feather="sun" class="w-5 h-5"></i><span class="font-bold text-lg">${counts.presentes}</span><span class="text-sm">Presentes</span></div><div class="flex items-center gap-2 text-red-600"><i data-feather="cloud-off" class="w-5 h-5"></i><span class="font-bold text-lg">${counts.ausentes}</span><span class="text-sm">Ausentes</span></div><div class="flex items-center gap-2 text-purple-600"><i data-feather="arrow-down-circle" class="w-5 h-5"></i><span class="font-bold text-lg">${counts.saida}</span><span class="text-sm">Saída</span></div></div>`;
                    return `<div class="flex flex-col"><div class="flex flex-wrap justify-between items-center gap-4">${filterHTML}</div>${countersHTML}</div>`;
                case 'hotel':
                    filterHTML = `<div><h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2 mb-4"><i data-feather="moon" class="w-6 h-6"></i>Visão do Hotel</h2><div class="flex flex-wrap items-center gap-4">
                                    <div class="flex items-center gap-2"><label for="date-filter" class="font-semibold">Data:</label><input type="date" id="date-filter" value="${dateFilters.hotel}" class="p-2 border rounded-md"></div>
                                    <div class="flex items-center gap-2"><label for="hotel-status-filter" class="font-semibold">Status:</label><select id="hotel-status-filter" class="p-2 border rounded-md form-select-dark-text"><option value="" ${currentHotelFilter === '' ? 'selected' : ''}>Todos</option><option value="Hospedado" ${currentHotelFilter === 'Hospedado' ? 'selected' : ''}>Hospedado</option><option value="Agendado" ${currentHotelFilter === 'Agendado' ? 'selected' : ''}>Reserva Futura</option><option value="Check-out/Finalizado" ${currentHotelFilter === 'Check-out/Finalizado' ? 'selected' : ''}>Saída</option></select></div>
                                    ${compactModeButtonHTML}
                                </div></div>`;
                    if (counts.hospedados !== undefined) countersHTML = `<div class="flex gap-4 mt-2"><div class="flex items-center gap-2 text-cyan-600"><i data-feather="moon" class="w-5 h-5"></i><span class="font-bold text-lg">${counts.hospedados}</span><span class="text-sm">Hospedados</span></div></div>`;
                    return `<div class="flex flex-col"><div class="flex flex-wrap justify-between items-center gap-4">${filterHTML}</div>${countersHTML}</div>`;
                case 'taxi': 
                    filterHTML = `<div><h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2 mb-4"><i data-feather="truck" class="w-6 h-6"></i>Visão do Taxi Dog</h2><div class="flex flex-wrap items-center gap-4">
                                    <div><label for="date-filter" class="font-semibold">Data:</label><input type="date" id="date-filter" value="${dateFilters.taxi}" class="p-2 border rounded-md"></div>
                                    <div>
                                        <label for="taxi-route-filter" class="font-semibold">Rota:</label>
                                        <select id="taxi-route-filter" class="p-2 border rounded-md form-select-dark-text">
                                            <option value="" ${currentTaxiRouteFilter === '' ? 'selected' : ''}>Todas</option>
                                            <option value="Rafael" ${currentTaxiRouteFilter === 'Rafael' ? 'selected' : ''}>Rafael</option>
                                            <option value="Douglas" ${currentTaxiRouteFilter === 'Douglas' ? 'selected' : ''}>Douglas</option>
                                            <option value="Matheus" ${currentTaxiRouteFilter === 'Matheus' ? 'selected' : ''}>Matheus</option>
                                            <option value="Avulso" ${currentTaxiRouteFilter === 'Avulso' ? 'selected' : ''}>Avulso</option>
                                        </select>
                                    </div>
                                    ${compactModeButtonHTML}
                                </div></div>`; 
                    return `<div class="mb-4 flex flex-wrap justify-between items-center gap-4">${filterHTML}</div>`;
             }
        }
        
        function addFilterEventListeners() {
            const dateFilter = document.getElementById('date-filter'); if (dateFilter) dateFilter.addEventListener('change', (e) => { dateFilters[currentTab] = e.target.value; renderContent(); });
            const hotelFilter = document.getElementById('hotel-status-filter'); if (hotelFilter) hotelFilter.addEventListener('change', (e) => { currentHotelFilter = e.target.value; renderContent(); });
            const taxiFilter = document.getElementById('taxi-route-filter'); if (taxiFilter) taxiFilter.addEventListener('change', (e) => { currentTaxiRouteFilter = e.target.value; renderContent(); });
            const serviceFilter = document.getElementById('service-filter'); if (serviceFilter) serviceFilter.addEventListener('change', (e) => { currentServiceFilter = e.target.value; renderContent(); });
            const crecheStatusFilter = document.getElementById('creche-status-filter'); if (crecheStatusFilter) crecheStatusFilter.addEventListener('change', (e) => { currentCrecheStatusFilter = e.target.value; renderContent(); });
            const sidebarToggle = document.getElementById('sidebar-toggle-btn'); if (sidebarToggle) sidebarToggle.addEventListener('click', () => toggleSidebar(!isSidebarVisible));
            
            const receptionSearch = document.getElementById('reception-search-filter');
            if (receptionSearch) {
                receptionSearch.addEventListener('input', (e) => {
                    receptionSearchTerm = e.target.value.toLowerCase();
                    renderContent();
                });
            }

            // Listeners para Histórico
            const historyDate = document.getElementById('filtro-data-historico');
            const historySearch = document.getElementById('busca-nome-historico');
            if(historyDate) historyDate.addEventListener('change', handleHistoryFilterChange);
            if(historySearch) historySearch.addEventListener('input', handleHistoryFilterChange);
        }
        function formatDate(ts, time) { if (!ts) return 'N/A'; const d = ts.toDate(), o = { day: '2-digit', month: '2-digit', year: 'numeric' }; if (time) { o.hour = '2-digit'; o.minute = '2-digit'; } return d.toLocaleString('pt-BR', o); }
        
        function createAppointmentCard(appt, isHistoryCard = false) {
            const { id, tutorName, petName, services = [], status = 'Agendado' } = appt;
            const card = document.createElement('div');
            card.dataset.id = id;
            
            const statusColors = { 'Agendado': 'bg-blue-100 text-blue-800', 'Presente': 'bg-green-200 text-green-800', 'Hospedado': 'bg-cyan-100 text-cyan-800', 'Ausente': 'bg-red-200 text-red-800', 'Check-out/Finalizado': 'bg-purple-100 text-purple-800' };
            const cardStatusClass = status ? statusColors[status] : '';
            
            card.className = "appointment-card relative border rounded-lg p-4 shadow-md flex flex-col";
            if(cardStatusClass) card.classList.add(...cardStatusClass.split(' '));
            
            let dateInfo = (services.includes('Hotel') && appt.hotelPeriodStart) ? `<p class="text-sm"><span class="font-semibold">Período:</span> ${formatDate(appt.hotelPeriodStart)} a ${formatDate(appt.hotelPeriodEnd)}</p><p class="text-sm"><span class="font-semibold">Data de Hoje:</span> ${formatDate(appt.checkinDate)}</p>` : `<p class="text-sm"><span class="font-semibold">Data:</span> ${formatDate(appt.checkinDate, true)}</p>`;
            let taxiInfo = services.includes('Taxi Dog') && appt.taxiDetails ? `<div class="mt-2 pt-2 border-t"><p class="font-semibold text-teal-700">Taxi Dog: ${appt.taxiDetails.route || 'N/A'}</p><p class="text-xs">Busca: ${appt.taxiDetails.pickupTime || 'N/A'} | Devolução: ${appt.taxiDetails.returnTime || 'N/A'}</p></div>` : '';
            
            card.innerHTML = `
                <div class="card-header flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold">${petName}</h3>
                        <p class="tutor-name text-sm text-gray-600 -mt-1">${tutorName}</p>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusColors[status] || ''}">${status}</span>
                </div>
                <div class="card-details">
                    <div class="text-gray-700 space-y-1 my-2">
                        ${dateInfo}
                        <p class="font-semibold">Serviços:</p>
                        <div class="flex flex-wrap gap-1 text-xs">${services.map(s => `<span class="bg-gray-200 px-2 py-1 rounded">${s}</span>`).join('')}</div>
                    </div>
                    ${taxiInfo}
                    ${appt.observations ? `<p class="text-xs italic mt-2 whitespace-pre-wrap"><strong>Obs:</strong> <span>${appt.observations}</span></p>` : ''}
                    <div class="mt-2 pt-2 border-t text-xs text-gray-500 bg-gray-50 p-2 rounded">
                        <p>${appt.checkinTimestamp ? `<strong>Entrada:</strong> ${formatDate(appt.checkinTimestamp, true)}` : ''}</p>
                        <p>${appt.checkoutTimestamp ? `<strong>Saída:</strong> ${formatDate(appt.checkoutTimestamp, true)}` : ''}</p>
                    </div>
                    <div class="botoes-porte"></div>
                    <div class="action-buttons mt-4 pt-4 border-t flex flex-wrap gap-2 justify-end"></div>
                </div>
            `;
            
            const buttonContainer = card.querySelector('.action-buttons');
            
            if (isHistoryCard) {
                const replicateButton = document.createElement('button');
                replicateButton.className = "action-btn bg-blue-500 hover:bg-blue-600";
                replicateButton.textContent = "Replicar";
                replicateButton.dataset.action = "replicate";
                buttonContainer.appendChild(replicateButton);
            } else {
                if (currentTab === 'creche' || currentTab === 'hotel') {
                    const porteButtons = card.querySelector('.botoes-porte');
                    porteButtons.innerHTML = `<button class="btn-mover-porte" data-action="move_to_group" data-grupo="grandes" title="Mover para Porte Grande">G</button><button class="btn-mover-porte" data-action="move_to_group" data-grupo="pequenos" title="Mover para Porte Pequeno">P</button>`;
                }
                
                if (currentTab === 'reception') {
                    const editButton = document.createElement('button');
                    editButton.className = "action-btn bg-yellow-500 hover:bg-yellow-600";
                    editButton.textContent = "Editar";
                    editButton.dataset.action = "edit";
                    buttonContainer.appendChild(editButton);
                }

                const isCrecheService = services.includes('Creche') || services.includes('Pacote de Creche');
                if (status === 'Agendado') {
                    if (isCrecheService) {
                        const presentButton = document.createElement('button'); presentButton.className = "action-btn bg-green-500 hover:bg-green-600"; presentButton.textContent = "Presente"; presentButton.dataset.action = 'present'; buttonContainer.appendChild(presentButton);
                        const absentButton = document.createElement('button'); absentButton.className = "action-btn bg-gray-500 hover:bg-gray-600"; absentButton.textContent = "Ausente"; absentButton.dataset.action = 'absent'; buttonContainer.appendChild(absentButton);
                    }
                    if (services.includes('Hotel')) {
                         const checkinHotelButton = document.createElement('button'); checkinHotelButton.className = "action-btn bg-blue-500 hover:bg-blue-600"; checkinHotelButton.textContent = "Entrada"; checkinHotelButton.dataset.action = 'checkin_hotel'; buttonContainer.appendChild(checkinHotelButton);
                    }
                } else if (status === 'Presente' && isCrecheService) {
                    const markAbsentButton = document.createElement('button'); markAbsentButton.className = "action-btn bg-gray-500 hover:bg-gray-600"; markAbsentButton.textContent = "Marcar Ausente"; markAbsentButton.dataset.action = 'absent'; buttonContainer.appendChild(markAbsentButton);
                    const checkoutCrecheButton = document.createElement('button'); checkoutCrecheButton.className = "action-btn bg-purple-500 hover:bg-purple-600"; checkoutCrecheButton.textContent = "Saída"; checkoutCrecheButton.dataset.action = 'checkout_creche'; buttonContainer.appendChild(checkoutCrecheButton);
                } else if (status === 'Ausente' && isCrecheService) {
                     const markPresentButton = document.createElement('button'); markPresentButton.className = "action-btn bg-green-500 hover:bg-green-600"; markPresentButton.textContent = "Marcar Presente"; markPresentButton.dataset.action = 'present'; buttonContainer.appendChild(markPresentButton);
                } else if (status === 'Hospedado') {
                     const checkoutHotelButton = document.createElement('button'); checkoutHotelButton.className = "action-btn bg-purple-500 hover:bg-purple-600"; checkoutHotelButton.textContent = "Saída"; checkoutHotelButton.dataset.action = 'checkout_hotel'; buttonContainer.appendChild(checkoutHotelButton);
                }

                if (services.includes('Hotel')) {
                    const checklistButton = document.createElement('button'); checklistButton.className = "action-btn bg-teal-500 hover:bg-teal-600"; checklistButton.textContent = "Checklist"; checklistButton.dataset.action = 'checklist'; buttonContainer.appendChild(checklistButton);
                }

                if (currentTab === 'reception') {
                    const deleteButton = document.createElement('button');
                    deleteButton.className = "action-btn bg-red-500 hover:bg-red-600";
                    deleteButton.textContent = "Excluir";
                    deleteButton.dataset.action = 'delete';
                    buttonContainer.appendChild(deleteButton);
                }
            }

            return card;
        }
        
        // --- FORM SUBMISSION LOGIC ---
        async function handleFormSubmit(e, prefix = "") {
            e.preventDefault(); if (!appointmentsColRef) return showConfirmationModal("Erro", "A conexão com o banco de dados não foi estabelecida.", null, true);
            const id = document.getElementById(`${prefix}booking-id`).value;
            const services = [];
            if (document.getElementById(`${prefix}service-creche`).checked) services.push('Creche'); if (document.getElementById(`${prefix}service-hotel`).checked) services.push('Hotel'); if (document.getElementById(`${prefix}service-bath`).checked) services.push('Saida com Banho'); if (document.getElementById(`${prefix}service-taxi`).checked) services.push('Taxi Dog'); if (document.getElementById(`${prefix}service-package-creche`).checked) services.push('Pacote de Creche');
            const baseData = { tutorName: document.getElementById(`${prefix}tutor-name`).value, petName: document.getElementById(`${prefix}pet-name`).value, petBreed: document.getElementById(`${prefix}pet-breed`).value, services, observations: document.getElementById(`${prefix}observations`).value || null };
            
            if (services.includes('Taxi Dog')) { 
                baseData.taxiDetails = { pickupTime: document.getElementById(`${prefix}taxi-pickup-time`).value || null, returnTime: document.getElementById(`${prefix}taxi-return-time`).value || null, route: document.getElementById(`${prefix}taxi-route`).value || null }; 
                if (!baseData.taxiDetails.route) return showConfirmationModal("Erro", "A seleção da rota é obrigatória para o serviço de Taxi Dog.", null, true);
            }
            
            try {
                if (id) {
                    let checkinDate, checkoutDate = null;
                     if (services.includes('Hotel')) {
                        const hotelCheckinValue = document.getElementById(`${prefix}hotel-checkin-date`).value; const hotelCheckoutValue = document.getElementById(`${prefix}hotel-checkout-date`).value;
                        if (!hotelCheckinValue || !hotelCheckoutValue) return showConfirmationModal("Erro", "Datas de check-in e check-out do hotel são obrigatórias.", null, true);
                        checkinDate = Timestamp.fromDate(new Date(hotelCheckinValue)); checkoutDate = Timestamp.fromDate(new Date(hotelCheckoutValue));
                    } else {
                        const genericDateValue = document.getElementById(`${prefix}generic-date`).value;
                        if(genericDateValue) checkinDate = Timestamp.fromDate(new Date(genericDateValue));
                    }
                    await updateDoc(doc(appointmentsColRef, id), { ...baseData, checkinDate, checkoutDate, hotelPeriodStart: checkinDate, hotelPeriodEnd: checkoutDate });
                    editModal.classList.add('hidden');
                } else {
                    const batch = writeBatch(db);
                    if (services.includes('Hotel')) {
                        const hotelCheckinValue = document.getElementById(`${prefix}hotel-checkin-date`).value; const hotelCheckoutValue = document.getElementById(`${prefix}hotel-checkout-date`).value;
                        if (!hotelCheckinValue || !hotelCheckoutValue) return showConfirmationModal("Erro", "Datas de check-in e check-out do hotel são obrigatórias.", null, true);
                        const startDate = new Date(hotelCheckinValue); const endDate = new Date(hotelCheckoutValue);
                        const hotelPeriodStart = Timestamp.fromDate(startDate); const hotelPeriodEnd = Timestamp.fromDate(endDate);
                        const bookingGroupId = crypto.randomUUID();
                        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                            const newDocRef = doc(appointmentsColRef);
                            const appointmentData = { ...baseData, checkinDate: Timestamp.fromDate(new Date(d)), bookingGroupId, hotelPeriodStart, hotelPeriodEnd, status: 'Agendado', createdAt: serverTimestamp() };
                            batch.set(newDocRef, appointmentData);
                        }
                    } else if (document.getElementById(`${prefix}service-package-creche`).checked && selectedPackageDates.length > 0) {
                        const timePart = document.getElementById(`${prefix}generic-date`).value?.split('T')[1] || '09:00';
                        selectedPackageDates.forEach(dateString => {
                            const newDocRef = doc(appointmentsColRef);
                            const appointmentData = { ...baseData, checkinDate: Timestamp.fromDate(new Date(`${dateString}T${timePart}`)), status: 'Agendado', createdAt: serverTimestamp() };
                            batch.set(newDocRef, appointmentData);
                        });
                    } else {
                        const genericDateValue = document.getElementById(`${prefix}generic-date`).value;
                        if (!genericDateValue) return showConfirmationModal("Erro", "A data do agendamento é obrigatória.", null, true);
                        const checkinDate = Timestamp.fromDate(new Date(genericDateValue));
                        await addDoc(appointmentsColRef, { ...baseData, checkinDate, checkoutDate: null, status: 'Agendado', createdAt: serverTimestamp() });
                        resetForm(); return;
                    }
                    await batch.commit();
                    resetForm();
                }
            } catch (error) { console.error("Error saving document: ", error); showConfirmationModal("Erro", "Ocorreu um erro ao salvar.", null, true); }
        }
        bookingForm.addEventListener('submit', (e) => handleFormSubmit(e, ''));
        editForm.addEventListener('submit', (e) => handleFormSubmit(e, 'edit-'));

        function resetForm() { bookingForm.innerHTML = getFormHTML(''); initializeFormLogic(''); selectedPackageDates = []; }

        // --- GLOBAL EVENT LISTENER (DELEGATION) ---
        mainContent.addEventListener('click', (e) => {
            const actionTarget = e.target.closest('[data-action]');
            const cardTarget = e.target.closest('.appointment-card');
            const toggleCompactBtn = e.target.closest('#btn-toggle-compacto');
            
            if (toggleCompactBtn) {
                isCompactMode = !isCompactMode;
                toggleCompactBtn.textContent = isCompactMode ? 'Visão Padrão' : 'Modo Compacto';
                contentDisplay.classList.toggle('modo-compacto', isCompactMode);
                if (!isCompactMode) {
                    contentDisplay.querySelectorAll('.appointment-card.expandido').forEach(card => card.classList.remove('expandido'));
                }
                return;
            }
            
            if (actionTarget) {
                e.stopPropagation(); 
                const action = actionTarget.dataset.action;
                const card = actionTarget.closest('[data-id]');
                const id = card ? card.dataset.id : null;
                
                if (action === 'move_to_group') {
                    const grupo = actionTarget.dataset.grupo;
                    if(id) {
                        cardGroupAssignments[id] = grupo;
                        renderContent();
                    }
                    return;
                }

                switch(action) {
                    case 'edit': if(id) openEditModal(id); break;
                    case 'delete': if(id) showConfirmationModal('Confirmar Exclusão', 'Tem certeza?', () => deleteAppointment(id)); break;
                    case 'replicate': if(id) handleReplicateClick(id); break;
                    case 'present': if(id) updateAppointmentStatus(id, 'Presente'); break;
                    case 'absent': if(id) updateAppointmentStatus(id, 'Ausente'); break;
                    case 'checkin_hotel': if(id) batchUpdateHotelStatus(id, 'Hospedado'); break;
                    case 'checkout_hotel': if(id) batchUpdateHotelCheckout(id); break;
                    case 'checkout_creche': if(id) updateAppointmentStatus(id, 'Check-out/Finalizado'); break;
                    case 'checklist': if(id) openChecklistModal(id); break;
                }
                return;
            }

            if (cardTarget && isCompactMode) {
                const currentExpanded = contentDisplay.querySelector('.appointment-card.expandido');
                if (currentExpanded && currentExpanded !== cardTarget) {
                    currentExpanded.classList.remove('expandido');
                }
                cardTarget.classList.toggle('expandido');
            }
        });
        
        function handleReplicateClick(id) {
            const appt = localAppointments.find(a => a.id === id);
            if (!appt) return;

            // Preenche os campos de texto
            document.getElementById('tutor-name').value = appt.tutorName || '';
            document.getElementById('pet-name').value = appt.petName || '';
            document.getElementById('pet-breed').value = appt.petBreed || '';
            document.getElementById('observations').value = appt.observations || '';

            // Reseta e preenche os checkboxes de serviços
            document.querySelectorAll('#booking-form .form-checkbox').forEach(cb => cb.checked = false);
            const serviceIdMap = { 'Creche': 'service-creche', 'Hotel': 'service-hotel', 'Saida com Banho': 'service-bath', 'Taxi Dog': 'service-taxi', 'Pacote de Creche': 'service-package-creche' };
            (appt.services || []).forEach(service => {
                const cbId = serviceIdMap[service];
                if (cbId) {
                    const checkbox = document.getElementById(cbId);
                    if (checkbox) checkbox.checked = true;
                }
            });

            // Limpa as datas para que o usuário insira novas
            document.getElementById('generic-date').value = '';
            document.getElementById('hotel-checkin-date').value = '';
            document.getElementById('hotel-checkout-date').value = '';
            selectedPackageDates = [];

            // Dispara eventos para atualizar a visibilidade dos campos condicionais
            document.getElementById('service-hotel').dispatchEvent(new Event('change'));
            document.getElementById('service-taxi').dispatchEvent(new Event('change'));
            document.getElementById('service-package-creche').dispatchEvent(new Event('change'));
            
            // Mostra a barra lateral se estiver oculta e rola para o topo
            if (bookingSidebar.classList.contains('hidden-sidebar')) {
                toggleSidebar(true);
            }
            bookingSidebar.scrollIntoView({ behavior: 'smooth' });
        }

        function atualizarContadores() {
            const grupoGrandes = document.getElementById('grupo-grandes');
            const grupoPequenos = document.getElementById('grupo-pequenos');
            const contadorGrandes = document.getElementById('contador-grandes');
            const contadorPequenos = document.getElementById('contador-pequenos');
            const contadorGeral = document.getElementById('contador-geral');
            if (grupoGrandes && grupoPequenos && contadorGrandes && contadorPequenos && contadorGeral) {
                const numGrandes = grupoGrandes.querySelectorAll('.appointment-card').length;
                const numPequenos = grupoPequenos.querySelectorAll('.appointment-card').length;
                contadorGrandes.textContent = numGrandes;
                contadorPequenos.textContent = numPequenos;
                contadorGeral.textContent = numGrandes + numPequenos;
            }
        }

        // --- LÓGICA DO HISTÓRICO ---
        function handleHistoryFilterChange() {
            const dateValue = document.getElementById('filtro-data-historico').value;
            const searchValue = document.getElementById('busca-nome-historico').value.toLowerCase();
            
            if (!dateValue && !searchValue) {
                renderHistoryResults([], true); // Limpa e mostra mensagem inicial
                return;
            }

            let results = localAppointments;

            if (dateValue) {
                const d = new Date(dateValue + 'T00:00:00');
                const s = toStartOfDay(d);
                const e = toEndOfDay(d);
                results = results.filter(a => {
                    const checkinDate = a.checkinDate?.toDate();
                    return checkinDate && checkinDate >= s && checkinDate <= e;
                });
            }

            if (searchValue) {
                results = results.filter(a => 
                    (a.petName?.toLowerCase() || '').includes(searchValue) ||
                    (a.tutorName?.toLowerCase() || '').includes(searchValue)
                );
            }

            renderHistoryResults(results, false);
        }

        function renderHistoryResults(appointments, isInitial) {
            const container = document.getElementById('historico-list-container');
            if (!container) return;

            container.innerHTML = '';
            if (isInitial) {
                container.innerHTML = `<p class="text-gray-500 col-span-full">Use os filtros acima para buscar no histórico.</p>`;
                return;
            }
            
            if (appointments.length === 0) {
                container.innerHTML = `<p class="text-gray-500 col-span-full">Nenhum resultado encontrado para os filtros aplicados.</p>`;
                return;
            }

            appointments.forEach(appt => {
                container.appendChild(createAppointmentCard(appt, true));
            });
            feather.replace();
        }
        
        function openEditModal(id) {
            const appt = localAppointments.find(a => a.id === id); if (!appt) return;
            editForm.innerHTML = getFormHTML('edit-'); const prefix = 'edit-';
            document.getElementById(`${prefix}booking-id`).value = appt.id;
            document.getElementById(`${prefix}tutor-name`).value = appt.tutorName || '';
            document.getElementById(`${prefix}pet-name`).value = appt.petName || '';
            document.getElementById(`${prefix}pet-breed`).value = appt.petBreed || '';
            document.getElementById(`${prefix}observations`).value = appt.observations || '';
            const toLocalISOString = (ts) => ts ? new Date(ts.toDate().getTime() - (ts.toDate().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
            (appt.services || []).forEach(s => { const cbId = { 'Creche': 'service-creche', 'Hotel': 'service-hotel', 'Saida com Banho': 'service-bath', 'Taxi Dog': 'service-taxi', 'Pacote de Creche': 'service-package-creche' }[s]; if (cbId) document.getElementById(`${prefix}${cbId}`).checked = true; });
            initializeFormLogic(prefix);
            if ((appt.services || []).includes('Hotel')) {
                document.getElementById(`${prefix}hotel-checkin-date`).value = toLocalISOString(appt.hotelPeriodStart || appt.checkinDate);
                document.getElementById(`${prefix}hotel-checkout-date`).value = toLocalISOString(appt.hotelPeriodEnd || appt.checkoutDate);
            } else { document.getElementById(`${prefix}generic-date`).value = toLocalISOString(appt.checkinDate); }
            if ((appt.services || []).includes('Taxi Dog') && appt.taxiDetails) {
                 document.getElementById(`${prefix}taxi-pickup-time`).value = appt.taxiDetails.pickupTime || '';
                 document.getElementById(`${prefix}taxi-return-time`).value = appt.taxiDetails.returnTime || '';
                 document.getElementById(`${prefix}taxi-route`).value = appt.taxiDetails.route || '';
            }
            document.getElementById(`${prefix}service-package-creche`).disabled = true;
            editModal.classList.remove('hidden');
        }

        function openChecklistModal(id) {
            const appt = localAppointments.find(a => a.id === id); if (!appt) return;
            checklistForm.dataset.id = id;

            checklistInfo.innerHTML = `
                <div class="text-center mb-4"><p class="text-sm text-gray-500">Período da Hospedagem</p><p class="font-semibold">${formatDate(appt.hotelPeriodStart)} a ${formatDate(appt.hotelPeriodEnd)}</p></div>
                <div class="grid grid-cols-3 gap-4 text-center"><div><p class="text-sm text-gray-500">Nome do Pet</p><p class="font-bold text-lg">${appt.petName}</p></div><div><p class="text-sm text-gray-500">Tutor</p><p class="font-bold text-lg">${appt.tutorName}</p></div><div><p class="text-sm text-gray-500">Raça</p><p class="font-bold text-lg">${appt.petBreed}</p></div></div>`;
            
            const items = ["Cama", "Casinha", "Cobertor", "Brinquedos", "Ração", "Coleira", "Petiscos", "Roupinhas", "Comedouro", "Medicamentos", "Instagram", "Contato"];
            checklistItemsContainer.innerHTML = items.map(item => {
                const sanitizedItem = item.toLowerCase().replace(/\s+/g, '-');
                const savedItem = appt.checklist ? appt.checklist[sanitizedItem] : null;
                const isYes = savedItem ? savedItem.has : false;
                const obs = savedItem ? savedItem.obs : '';
                return `<div class="grid grid-cols-1 sm:grid-cols-3 items-center gap-2 border-t pt-4"><label class="font-semibold">${item}</label><div class="flex items-center gap-4"><label><input type="radio" name="${sanitizedItem}" value="sim" ${isYes ? 'checked' : ''}> Sim</label><label><input type="radio" name="${sanitizedItem}" value="nao" ${!isYes ? 'checked' : ''}> Não</label></div><textarea name="${sanitizedItem}-obs" placeholder="Observações..." class="form-input text-sm p-2 h-12">${obs}</textarea></div>`;
            }).join('');
            
            document.getElementById('observacoes-gerais').value = appt.checklist?.observacoesGerais || '';
            checklistModal.classList.remove('hidden');
        }
        
        async function deleteAppointment(id) { try { await deleteDoc(doc(appointmentsColRef, id)); } catch (error) { console.error("Error deleting document: ", error); showConfirmationModal("Erro", "Não foi possível excluir.", null, true); } }
        
        async function batchUpdateHotelStatus(clickedApptId, newStatus) {
            const clickedAppt = localAppointments.find(a => a.id === clickedApptId); if (!clickedAppt || !clickedAppt.bookingGroupId) { updateAppointmentStatus(clickedApptId, newStatus); return; }
            const batch = writeBatch(db);
            const relatedAppointments = localAppointments.filter(a => a.bookingGroupId === clickedAppt.bookingGroupId);
            const timestamp = serverTimestamp();
            relatedAppointments.forEach(appt => { 
                const docRef = doc(appointmentsColRef, appt.id);
                batch.update(docRef, { status: newStatus, checkinTimestamp: timestamp, checkoutTimestamp: null }); 
            });
            try { await batch.commit(); } catch (error) { console.error("Error batch updating status: ", error); showConfirmationModal("Erro", "Não foi possível atualizar o status do hotel.", null, true); }
        }
        
        async function batchUpdateHotelCheckout(clickedApptId) {
            const clickedAppt = localAppointments.find(a => a.id === clickedApptId); if (!clickedAppt || !clickedAppt.bookingGroupId) { updateAppointmentStatus(clickedApptId, 'Check-out/Finalizado'); return; }
            const batch = writeBatch(db);
            const relatedAppointments = localAppointments.filter(a => a.bookingGroupId === clickedAppt.bookingGroupId);
            const actualCheckoutDate = clickedAppt.checkinDate.toDate();
            const timestamp = serverTimestamp();
            relatedAppointments.forEach(appt => {
                const docRef = doc(appointmentsColRef, appt.id);
                const apptDate = appt.checkinDate.toDate();
                if (apptDate > actualCheckoutDate) { batch.delete(docRef); } else if (appt.status !== 'Check-out/Finalizado') { batch.update(docRef, { status: 'Check-out/Finalizado', checkoutTimestamp: timestamp }); }
            });
            try { await batch.commit(); } catch (error) { console.error("Error batch updating checkout status: ", error); showConfirmationModal("Erro", "Não foi possível finalizar a estadia do hotel.", null, true); }
        }

        async function updateAppointmentStatus(id, newStatus) {
            try {
                const docRef = doc(appointmentsColRef, id);
                const dataToUpdate = { status: newStatus };

                if (newStatus === 'Presente' || newStatus === 'Hospedado') {
                    dataToUpdate.checkinTimestamp = serverTimestamp();
                    dataToUpdate.checkoutTimestamp = null;
                } else if (newStatus === 'Check-out/Finalizado') {
                    dataToUpdate.checkoutTimestamp = serverTimestamp();
                } else if (newStatus === 'Agendado' || newStatus === 'Ausente') {
                    dataToUpdate.checkinTimestamp = null;
                    dataToUpdate.checkoutTimestamp = null;
                }

                await updateDoc(docRef, dataToUpdate);
            } catch (error) { console.error("Error updating status: ", error); showConfirmationModal("Erro", "Não foi possível atualizar o status.", null, true); }
        }

        checklistForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const id = e.target.dataset.id; if (!id) return;
            const formData = new FormData(e.target);
            const checklistData = {};
            const items = ["Cama", "Casinha", "Cobertor", "Brinquedos", "Ração", "Coleira", "Petiscos", "Roupinhas", "Comedouro", "Medicamentos", "Instagram", "Contato"];
            items.forEach(item => { const sanitizedItem = item.toLowerCase().replace(/\s+/g, '-'); checklistData[sanitizedItem] = { has: formData.get(sanitizedItem) === 'sim', obs: formData.get(`${sanitizedItem}-obs`) || '' }; });
            checklistData.observacoesGerais = formData.get('observacoes-gerais') || '';
            try { const docRef = doc(appointmentsColRef, id); await updateDoc(docRef, { checklist: checklistData }); checklistModal.classList.add('hidden'); } catch (error) { console.error("Error saving checklist:", error); showConfirmationModal("Erro", "Não foi possível salvar o checklist.", null, true); }
        });
        
        function printChecklist() {
            const printableContent = document.getElementById('printable-checklist').innerHTML;
            const printWindow = window.open('', '', 'height=800,width=800');
            printWindow.document.write(`<html><head><title>Checklist de Hospedagem</title><script src="https://cdn.tailwindcss.com"><\/script><style>@media print { body { font-size: 10pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .no-print { display: none !important; } form { display: block !important; } textarea { border: 1px solid #ccc !important; } }</style></head><body>${printableContent}</body></html>`);
            printWindow.document.close();
            setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
        }
        
        // --- MODAL CONTROLS ---
        closeEditModalBtn.addEventListener('click', () => editModal.classList.add('hidden'));
        closeChecklistModalBtn.addEventListener('click', () => checklistModal.classList.add('hidden'));

        let confirmCallback = null;
        function showConfirmationModal(title, message, callback, isError = false) {
            modalTitle.textContent = title; modalMessage.textContent = message;
            confirmCallback = callback;
            modalConfirmBtn.classList.toggle('hidden', isError);
            modalCancelBtn.textContent = isError ? 'Fechar' : 'Cancelar';
            confirmationModal.classList.remove('hidden');
        }
        modalConfirmBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(); confirmationModal.classList.add('hidden'); });
        modalCancelBtn.addEventListener('click', () => { confirmationModal.classList.add('hidden'); });

        // --- INITIAL SETUP ---
        bookingForm.innerHTML = getFormHTML('');
        initializeFormLogic('');
        updateLayoutForTab();
        feather.replace();

    </script>
</body>
</html>
